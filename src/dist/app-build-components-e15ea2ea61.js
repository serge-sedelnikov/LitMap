"bundle";!function(){var a=System.amdDefine;a("components/admin.html!github:systemjs/plugin-text@0.0.4.js",[],function(){return'<template> <require from="../elements/adminMarkerInfo"></require> <require from="../elements/markerEditModal"></require> <div class="page-content container"> <section> <h4> <i class="fa fa-map-marker"></i>&nbsp;<span t="admin.mapPoints"></span> </h4> <div class="row"> <div class="col-lg-12"> <div class="section section-fixed text-center" style="margin-left:8px;margin-right:8px;min-height:300px"> <div style="margin-top:86px"> <div t="admin.controls"></div> <a href="JavaScript:void(0);" click.delegate="addMarker()" class="btn btn-default"> <i class="fa fa-plus"></i>&nbsp;<span t="admin.item.add"></span> </a> <button class="btn btn-success" click.delegate="saveIndex()"> <i class="fa fa-save"></i>&nbsp;<span t="admin.edit.save"></span> </button> <button class="btn btn-link danger" style="margin-top:6px" click.delegate="refreshIndex()"> <i class="fa fa-refresh"></i>&nbsp;<span t="admin.edit.revert"></span> </button> </div> </div> <admin-marker-info repeat.for="m of markers" item.bind="m" index.bind="$index"></admin-marker-info> </div> </div> </section> </div> <marker-edit-modal ref="editModal" item.bind="currentMarker"></marker-edit-modal>  </template>'})}(),System.register("components/admin.js",["aurelia-framework","fetch","aurelia-fetch-client","aurelia-event-aggregator","jquery","lodash"],function(a){"use strict";var b,c,d,e,f,g;return{setters:[function(a){b=a.inject},function(a){},function(a){c=a.HttpClient},function(a){d=a.EventAggregator},function(a){e=a["default"]},function(a){f=a["default"]}],execute:function(){g=function(){function a(a,b){babelHelpers.classCallCheck(this,g),this.http=a,this.ea=b,this.subscriptions=[]}babelHelpers.createClass(a,[{key:"activate",value:function(){var a=this;return this.subscriptions.push(this.ea.subscribe("admin-marker-edit",function(b){a.editMarker(b)})),this.subscriptions.push(this.ea.subscribe("admin-marker-saved",function(b){a.markerSaved(b)})),this.subscriptions.push(this.ea.subscribe("admin-marker-delete",function(b){a.markerDelete(b)})),this.refreshIndex()}},{key:"detached",value:function(){f.forEach(this.subscriptions,function(a){a.dispose()})}},{key:"refreshIndex",value:function(){var a=this,b=this.fetchIndex();return b.then(function(b){a.markers=f.reverse(b)})}},{key:"fetchIndex",value:function(){return this.http.fetch("data/index.json?t="+(new Date).getTime()).then(function(a){return a.json()}).then(function(a){var b=a;return b})}},{key:"editMarker",value:function(a){var b=jQuery.extend({},a);this.currentMarker=b,e(this.editModal).find(".modal").modal()}},{key:"addMarker",value:function(){this.currentMarker={marker:"",pos:[57.180707,65.517749],color:"#EF6C00",data:"название файла"},e(this.editModal).find(".modal").modal()}},{key:"markerSaved",value:function(a){var b=f.find(this.markers,function(b){return b.data==a.data});if(b){var c=f.indexOf(this.markers,b);this.markers.splice(c,0,a),f.pull(this.markers,b)}else this.markers.splice(0,0,a)}},{key:"markerDelete",value:function(a){var b=f.find(this.markers,function(b){return b.data==a.data});if(b){f.indexOf(this.markers,b);f.pull(this.markers,b)}}},{key:"uploadFile",value:function(a){if(!a)return null;var b=new FormData;return b.append("data",a),b.append("targetFileName","index.json"),this.http.fetch("textupload.php",{method:"POST",body:b})}},{key:"saveIndex",value:function(){var a=JSON.stringify(this.markers);this.uploadFile(a)}}]);var g=a;return a=b(c,d)(a)||a}(),a("Admin",g)}}}),function(){var a=System.amdDefine;a("components/details.html!github:systemjs/plugin-text@0.0.4.js",[],function(){return'<template> <require from="./detailsClose"></require> <div class="page-content container"> <div> <div class="col-sm-3 hidden-xs"> <div class="section"> <h5 t="details.closeToThisPlace"></h5> <hr> <details-close parent-data.bind="currentDetails"></details-close> </div> </div> <div class="col-sm-9 col-xs-12 data" id="data"> <div class="section" innerHTML.bind="data"></div> <div class="section"> <div id="mc-container"></div> </div> </div> </div> </div> </template>'})}(),System.register("components/details.js",["fetch","aurelia-fetch-client","aurelia-framework","aurelia-i18n","lodash","../elements/mediaAdjuster","remarkable"],function(a){"use strict";var b,c,d,e,f,g,h,i;return{setters:[function(a){},function(a){b=a.HttpClient},function(a){c=a.inject,d=a.bindable},function(a){e=a.I18N},function(a){f=a["default"]},function(a){g=a["default"]},function(a){h=a["default"]}],execute:function(){i=function(){function a(a,b,c){babelHelpers.classCallCheck(this,d),this.http=b,this.i18n=a,this.element=c,this.data=""}babelHelpers.createClass(a,[{key:"activate",value:function(a){var b=this;this.link=a.data;var c=this.fetchIndex(),d=this.fetchData(this.link).then(function(){b.initializeComments(b.link)});return Promise.all([c,d])}},{key:"fetchIndex",value:function(){var a=this;return this.http.fetch("data/index.json").then(function(a){return a.json()}).then(function(b){var c=b,d=f.find(c,function(b){return b.data==a.link});return d}).then(function(b){a.currentDetails=b})}},{key:"fetchData",value:function(a){var b=this,c=new h({html:!0});return this.http.fetch("data/full/"+a+".md").then(function(a){return a.text()}).then(function(a){var d=c.render(a);d=g.adjustMedia(d),b.data=d})}},{key:"initializeComments",value:function(a){window.cackle_widget=[],window.cackle_widget.push({widget:"Comment",id:43259,channel:a}),Cackle.bootstrap(!0)}}]);var d=a;return a=c(e,b,Element)(a)||a}(),a("Details",i)}}}),function(){var a=System.amdDefine;a("components/detailsClose.html!github:systemjs/plugin-text@0.0.4.js",[],function(){return'<template> <require from="../elements/closeInfo"></require> <close-info class="info-tile" repeat.for="i of closeInfos" data.bind="i"></close-info> </template>'})}(),System.register("components/detailsClose.js",["fetch","aurelia-fetch-client","aurelia-framework","aurelia-i18n","lodash"],function(a){"use strict";var b,c,d,e,f,g;return{setters:[function(a){},function(a){b=a.HttpClient},function(a){c=a.inject,d=a.bindable},function(a){e=a.I18N},function(a){f=a["default"]}],execute:function(){g=function(){function a(a,b,c){babelHelpers.classCallCheck(this,h),babelHelpers.defineDecoratedPropertyDescriptor(this,"parentData",g),this.http=b,this.i18n=a,this.element=c,this.data="",this.closeInfos=[],this.self=this}var g={},g={};babelHelpers.createDecoratedClass(a,[{key:"parentData",decorators:[d],initializer:null,enumerable:!0}],null,g),babelHelpers.createDecoratedClass(a,[{key:"parentDataChanged",value:function(){return this.fetchIndex()}},{key:"bind",value:function(){return this.fetchIndex()}},{key:"fetchIndex",value:function(){var a=this,b=new L.LatLng(this.parentData.pos[0],this.parentData.pos[1]);return this.http.fetch("data/index.json").then(function(a){return a.json()}).then(function(c){var d=c;d=f.sortBy(d,function(a){var c=new L.LatLng(a.pos[0],a.pos[1]);return a.distance=b.distanceTo(c).toFixed(0),parseInt(a.distance)}),a.closeInfos=f.filter(d,function(a){return a.distance>0&&a.distance<=1e4})})}}],null,g);var h=a;return a=c(e,b,Element)(a)||a}(),a("DetailsClose",g)}}}),function(){var a=System.amdDefine;a("components/feedback.html!github:systemjs/plugin-text@0.0.4.js",[],function(){return'<template> <div class="page-content container"> <section> <h4><i class="fa fa-smile-o"></i>&nbsp;<span t="feedback.title"></span></h4> </section> <section> <div class="section"> <div id="mc-container"></div> </div> </section> </div> </template>'})}(),System.register("components/feedback.js",[],function(a){"use strict";var b;return{setters:[],execute:function(){b=function(){function a(){babelHelpers.classCallCheck(this,a)}return babelHelpers.createClass(a,[{key:"activate",value:function(){this.initializeComments("lit_map_general_feedback")}},{key:"initializeComments",value:function(a){window.cackle_widget=[],window.cackle_widget.push({widget:"Comment",id:43259,channel:a}),Cackle.bootstrap(!0)}}]),a}(),a("Feedback",b)}}}),function(){var a=System.amdDefine;a("components/home.html!github:systemjs/plugin-text@0.0.4.js",[],function(){return'<template> <require from="../elements/wall"></require> <div class="section no-shadow index-top bg-books page-content"> <div class="text-center"> <h1>Литературная карта</h1> <h2>города Тюмени</h2> </div> </div> <div class="container"> <section> <h4><i class="fa fa-star"></i>&nbsp;<span t="home.interestingThisWeek"></span></h4> <wall show-distance.bind="false" infos.bind="infos"></wall> </section> <section if.bind="closestInfos.length"> <h4><i class="fa fa-map-marker"></i>&nbsp;<span t="home.nearMe"></span></h4> <wall infos.bind="closestInfos"></wall> </section> </div> </template>'})}(),System.register("components/home.js",["fetch","aurelia-fetch-client","aurelia-framework","aurelia-i18n","lodash"],function(a){"use strict";var b,c,d,e,f,g;return{setters:[function(a){},function(a){b=a.HttpClient},function(a){c=a.inject,d=a.bindable},function(a){e=a.I18N},function(a){f=a["default"]}],execute:function(){g=function(){function a(a,b,c){babelHelpers.classCallCheck(this,d),this.http=b,this.i18n=a,this.element=c,this.infos=[],this.closestInfos=[]}babelHelpers.createClass(a,[{key:"activate",value:function(){var a=this,b=this.fetchIndex();b.then(function(b){return a.infos=f.reverse(f.takeRight(b,8)),a.getClosestToMe(b)}).then(function(b){a.closestInfos=b})}},{key:"fetchIndex",value:function(){return this.http.fetch("data/index.json?t="+(new Date).getTime()).then(function(a){return a.json()}).then(function(a){var b=a;return b})}},{key:"getClosestToMe",value:function(a){if(!navigator.geolocation)return[];var b=new Promise(function(a,b){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){var c={Lat:0,Lon:0};c.Lat=b.coords.latitude,c.Lon=b.coords.longitude,a(c)},function(b){a(null)}):a(null)}).then(function(b){if(!b)return[];var c=new L.LatLng(b.Lat,b.Lon),d=f.sortBy(a,function(a){var b=new L.LatLng(a.pos[0],a.pos[1]);return a.distance=c.distanceTo(b).toFixed(0),parseInt(a.distance)}),e=f.filter(d,function(a){return a.distance>0&&a.distance<=5e6});return e=f.take(e,4)});return b}}]);var d=a;return a=c(e,b,Element)(a)||a}(),a("Home",g)}}}),function(){var a=System.amdDefine;a("components/map.html!github:systemjs/plugin-text@0.0.4.js",[],function(){return'<template> <div id="map"></div> </template>'})}(),System.register("components/map.js",["lodash","fetch","aurelia-fetch-client","aurelia-framework","aurelia-i18n","../elements/mediaAdjuster","remarkable"],function(a){"use strict";var b,c,d,e,f,g,h;return{setters:[function(a){b=a["default"]},function(a){},function(a){c=a.HttpClient},function(a){d=a.inject},function(a){e=a.I18N},function(a){f=a["default"]},function(a){g=a["default"]}],execute:function(){h=function(){function a(a,b,c){babelHelpers.classCallCheck(this,h),this.self=this,self.http=b,self.i18bn=a,this.element=c}babelHelpers.createClass(a,[{key:"fetchMarkers",value:function(a,c){var d=new L.MarkerClusterGroup;b.forEach(a,function(a){var b=L.marker(new L.LatLng(a.pos[0],a.pos[1]),{icon:L.mapbox.marker.icon({"marker-symbol":a.marker,"marker-color":a.color,"marker-size":"large"})}),c=new g({html:!0});self.http.fetch("data/thumbs/"+a.data+".md").then(function(a){return a.text()}).then(function(e){var g=c.render(e);g=f.adjustMedia(g),b.bindPopup('<div class="marker-thumb">'+g+'</div><div class="text-right"><a href="/#/'+a.data+'" class="btn btn-default">'+self.i18bn.i18next.t("map.marker.readMore")+"</a></div>"),d.addLayer(b)})}),c.addLayer(d)}},{key:"fetchIndex",value:function(a){var b=this,c="data/index.json?t="+(new Date).getTime();console.log(c),self.http.fetch(c).then(function(a){return a.json()}).then(function(c){b.fetchMarkers(c,a)})}},{key:"attached",value:function(){self.map=L.mapbox.map("map","mapbox.streets").setView([57.15,65.53333],11),this.fetchIndex(self.map)}}]);var h=a;return a=d(e,c,Element)(a)||a}(),a("Map",h)}}});